<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>MedIns Chatbot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="static/style.css">

    <style>
       .message {
            margin-bottom: 15px;
        }
        .chat-body {
            padding: 15px;
            overflow-y: auto;
            height: 75vh;
        }

        .user-message {
    background-color: #071330;
    color: white;
    border-radius: 30px 30px 10px 30px;
    padding: 10px 20px;
    display: inline-block;
    align-self: flex-end; /* Align user messages to the right */
    margin-left: auto;    /* Move user messages to the right */
    margin-right: 10px;   /* Add some margin between user and bot messages */
    max-width: 700px;
}

.user-span {
    padding: 0px 10px;
    display: inline-block;
    align-self: flex-end;
    margin-left: auto;
    margin-right: 10px;
  
}

.assistant-message {
    background-color: #f0f0f0;
    border: 1px solid #ddd;
    border-radius: 10px 30px 30px 30px;
    padding: 10px 20px;
    display: inline-block;
    align-self: flex-start; /* Align bot messages to the left */
    margin-right: auto;     /* Move bot messages to the left */
    margin-left: 10px;
    max-width: 700px;
}

.assistant-span {
    padding: 0px 10px;
    display: inline-block;
    align-self: flex-start; /* Align bot messages to the left */
    margin-right: auto;     /* Move bot messages to the left */
    margin-left: 10px;      /* Add some margin between user and bot messages */
}


        .input-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #fff;
            padding: 10px;
            border-top: 1px solid #ddd;
        }


        .payload-button {
          width: fit-content;
    color: #000;
    padding: 10px 15px;
    border-radius: 10px;
    margin-left: 20px;
    margin-bottom: 5px;
    cursor: pointer;
    transition: 0.3s ease;
    min-width: 200px;
    margin-bottom: 7px;
    max-width: 350px;
    background: #FFF;
    border: none;
    box-shadow: 0 3px 10px rgb(0 0 0 / 0.2);
        }
        .payload-button:hover {
            background: #ddd;
        }
        div {
            display: inline-grid;
            grid-auto-rows: min-content;
        }
        .sidebar-btn {
            width: 40px;
            height: 40px;
            margin-left: 15px;
        }

        .read-aloud-btn {
          border-radius: 30px;
    border: 3px solid white;
    color: black;
    padding: 5px 10px;
    margin-left: 10px;
    cursor: pointer;
}
/* New style for h1 */
.assistant-message h1 {
            font-size: 20px;
        }
      

    </style>
</head>
<body>

<div id="wrapper">
    <!-- Left Sidebar -->
    <div id="sidebar1">
        <div class="text-center">
	    <button class="sidebar-btn btn-light " data-bs-toggle="modal" data-bs-target="#exampleModal1"> <i class="fa-solid fa-user"></i> </button>
        </div>

        <div class="text-center">
            <button class="sidebar-btn btn-light settingsBtn" data-bs-toggle="modal" data-bs-target="#exampleModal2"> <i class="fa-solid fa-sliders"></i></button>
        </div>

        <div class="text-center">
            <button class="sidebar-btn btn-light logoutBtn"> <a href="/user/signout" style="text-decoration: none;color: #000;"> <i class="fa-solid fa-right-from-bracket"></i> </a></button>
        </div>
    </div>

    <div id="sidebar2">
        <div class="text-center2">
            <h5> <i class="fa-solid fa-clock-rotate-left"></i> History</h5>
            <hr style="color: #000; width:250px;">
        </div>
    </div>

<div class="dropdown_menu">
<h5> <i class="fa-solid fa-clock-rotate-left"></i> History</h5>
</div>


    <!-- Right Chat Container -->
    <div id="chat-container">

<div class="d-flex justify-content-between">
    <div class="toggle_btn"><i class="fa-solid fa-bars"></i></div>

    <h5 style="color:#071330; font-weight:700;">MedIns Chatbot</h5>
    <button class="get-btn" type="button"> New chat <i class="fa-solid fa-pen-to-square"></i> </button>
</div>

<!-- Chatbot message space -->
    <div class="chat-body" id="chatBody">
        {% for message in result %}
            {% if message[0] == "user" %}
                <div class="message"><div class="user-message">{{ message[1] }}</div> <span class="user-span"> You </span> </div>

            {% elif message[0] == "bot" %}
            <div class="message">
              <div class="assistant-message">
                {{ message[1] }}

              </div>
              <span class="assistant-span"> Bot </span>
              
          </div>
          
            {% endif %}
        {% endfor %}
    </div>


<div id="user-input" class="input-group mb-3 form-control">
            
            <input type="text" id="userInput" name="input" name="msg" class="message-input" placeholder="Type your message...">
            <!-- <button class="btn btn-light" type="button" id="voice-btn" style="margin-right: 5px;"> <i class="fa-solid fa-microphone"></i> </button> -->
            <button id="toggleButton" class="btn btn-light" type="button" onclick="speechText()" style="margin-right:20px;"> <i class="fa-solid fa-microphone"></i> </button>
            <button class="btn btn-light" type="button" id="sendMessage" onclick="sendMessage()"> <i class="fa-solid fa-paper-plane"></i> </button>
        </div>
    </div>
</div>

<!--Account Modal -->
<div class="modal fade" id="exampleModal1" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel"> Account </h5>
        <button type="button" class="get-btn" data-bs-target="#exampleModalToggle2" data-bs-toggle="modal"> <i class="fa-solid fa-pen"></i> Change Password</button>
      </div>
      <div class="modal-body">

<form class="row g-3">

  <div class="col-md-3">
    <h5> User Id </h5>
  </div>
  <div class="col-md-9">
    <input type="text" class="form-control" id="password" value="" readonly>
  </div>

  <div class="col-md-3">
    <h5> Name  </h5>
  </div>
  <div class="col-md-9">
    <input type="text" class="form-control" id="username" value="" readonly>
  </div>

  <div class="col-md-3">
    <h5> Email ID  </h5>
  </div>
  <div class="col-md-9">
    <input type="text" class="form-control" id="email" value="" readonly>
  </div>

  <div class="col-md-3">
    <h5> Mobile No  </h5>
  </div>
  <div class="col-md-9">
    <input type="text" class="form-control" id="mobile" value="" readonly>
  </div>

  <div class="col-md-12">
    <p>* You can't edit your user id.</p>
  </div>
</form>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal"> <i class="fa-solid fa-xmark"></i> Close</button>
        <button type="button" class="get-btn" data-bs-dismiss="modal"> <i class="fa-solid fa-check"></i> Save changes </button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="exampleModalToggle2" aria-hidden="true" aria-labelledby="exampleModalToggleLabel2" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="exampleModalToggleLabel2">Change Password</h1>
        <button type="button" class="btn-close" data-bs-target="#exampleModal1" data-bs-toggle="modal"></button>
      </div>
      <div class="modal-body">

        <form class="row g-3" action="/user/update_password" method="post">

          <div class="col-md-5">
            <h5> New Password  </h5>
          </div>
          <div class="col-md-7">
            <input type="password" class="form-control" id="new_password" name="new_password" placeholder="Password" maxlength="8">
          </div>

          <div class="col-md-5">
            <h5> Confirm Password  </h5>
          </div>
          <div class="col-md-7">
            <input type="password" class="form-control" id="confirm_password" name="confirm_password" placeholder="Password" maxlength="8">
          </div>

          <div class="col-md-8"></div>
          <div class="col-md-4"></div>

          <div class="col-md-8"></div>
          <div class="col-md-4">
            <button type="submit" class="get-btn"> <i class="fa-solid fa-check"></i> Save Changes</button>
          </div>
          
        </form>

      </div>
    </div>
  </div>
</div>


<!--Settings Modal -->
<div class="modal fade" id="exampleModal2" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel"> Settings </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal"> <i class="fa-solid fa-xmark"></i> Close</button>
        <button type="button" class="get-btn" id="savechangesBtn"> <i class="fa-solid fa-check"></i> Save changes</button>
      </div>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

<script>
  var input = document.getElementById("userInput");
  input.addEventListener("keypress", function(event) {
    if(event.key === "Enter") {
      event.preventDefault();
      document.getElementById("sendMessage").click();
    }
  });
  </script>
  
<script>
function speechText(){
    // const toggleButton = document.getElementById('toggleButton');
  const outputInput = document.getElementById('userInput');
  const recognition = new webkitSpeechRecognition() || new SpeechRecognition();
  let isListening = false;
  let transcript;
  // recognition.interimResults = true;
  recognition.continuous = false;

      if (!isListening) {
          recognition.start();
          toggleButton.innerHTML = '<i class="fas fa-stop"></i>';
          isListening = true;
      } else {
          recognition.stop();
          toggleButton.innerHTML = '<i class="fas fa-microphone"></i>';
          isListening = false;
      }
      // recognition.onresult = function(e){
      //   console.log("JJJJjj",e);
      //   const result = e.results[0][0];
      //   transcript = result.transcript.toLowerCase();
      //   outputInput.value = result;
      //   sendMessage();
      // }
      recognition.onresult = event => {
      console.log("abcd");
      const result = Array.from(event.results)
          .map(result => result[0].transcript)
          .join('');
    //   if (str.slice(-1) === '.') {
    // // Remove the last character
    //     str = str.slice(0, -1);
    //   }
      outputInput.value = result;
      sendMessage();
  };
  
  recognition.onend = () => {
      toggleButton.innerHTML = '<i class="fas fa-microphone"></i>';
      isListening = false;
  };
  
  recognition.onerror = event => {
      console.error('Speech recognition error:', event.error);
  };
  
  // recognition.onnomatch = () => {
  //     console.log('No speech was recognized.');
  // };       

  
  }

    function sendMessage() {
        var userInput = document.getElementById('userInput').value;
        var chatBody = document.getElementById('chatBody');

        // Append user message to chat body
        chatBody.innerHTML += '<div class="message"><div class="user-message">' + userInput + '</div></div>';

        // Send user message to Flask route
        fetch('/result', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 'message': userInput }),
        })
            .then(response => response.json())
            .then(data => {
                console.log('Received data:', data);

                // Append bot response to chat body
                chatBody.innerHTML += `<div class="message">
                            <div class="assistant-message">
                              ${data['bot_response']}
                              <button class="read-aloud-btn" onclick="readAloud(this, '${data['bot_response']}')">
                                <i class="fa-solid fa-volume-low"></i>
                              </button>
                            </div> 
                          </div>`;

                // Check if bot response contains buttons
                if (data['buttons']) {
                    console.log('Received buttons:', data['buttons']);

                    // Append buttons to chat body
                    var buttonsContainer = document.createElement('div');
                    buttonsContainer.classList.add('message');

                    data['buttons'].forEach(button => {
                        var buttonElement = document.createElement('button');
                        buttonElement.classList.add('payload-button');
                        buttonElement.textContent = button.title;
                        buttonElement.onclick = function () {
                            sendPayload(button.payload, button.title);
                        };

                        buttonsContainer.appendChild(buttonElement);
                    });

                    chatBody.appendChild(buttonsContainer);
                }

                // Check if bot response contains attachments
                if (data['attachment']) {
                    console.log('Received attachments:', data['attachment']);

                    // Append attachment to chat body
                    var attachmentContainer = document.createElement('div');
                    attachmentContainer.classList.add('message');

                    var attachmentElement = document.createElement('div');
                    attachmentElement.classList.add('card');

                    // Construct HTML for the attachment
                    attachmentElement.innerHTML = `
                        <div class="card-title">${data['attachment']['payload']['elements'][0]['title']}</div>
                        <div class="card-subtitle">${data['attachment']['payload']['elements'][0]['subtitle']}</div>
                        <button class="card-button" onclick="confirmPurchase('${data['attachment']['payload']['elements'][0]['buttons'][0]['payload']}')">Confirm</button>
                        <button class="card-button" onclick="cancelPurchase('${data['attachment']['payload']['elements'][0]['buttons'][1]['payload']}')">Cancel</button>
                    `;

                    attachmentContainer.appendChild(attachmentElement);
                    chatBody.appendChild(attachmentContainer);
                }

            })
            .catch(error => {
                console.error('Error:', error);
            });

        // Clear the user input field
        document.getElementById('userInput').value = '';
    }

    function confirmPurchase(payload) {
        sendPayload(payload, "Confirm");
    }

    function cancelPurchase(payload) {
        sendPayload(payload, "Cancel");
    }

    function sendPayload(payload, title) {
        // Append user message for the clicked payload button
        chatBody.innerHTML += '<div class="message"><div class="user-message">' + title + '</div></div>';

        // Send payload to Flask route
        fetch('/result', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 'message': payload }),
        })
            .then(response => response.json())
            .then(data => {
                console.log('Received data:', data);

                // Append bot response to chat body
                chatBody.innerHTML += '<div class="message"><div class="assistant-message">' + data['bot_response'] + '</div></div>';

                // Check if bot response contains buttons
                if (data['buttons']) {
                    console.log('Received buttons:', data['buttons']);

                    // Append buttons to chat body
                    var buttonsContainer = document.createElement('div');
                    buttonsContainer.classList.add('message');

                    data['buttons'].forEach(button => {
                        var buttonElement = document.createElement('button');
                        buttonElement.classList.add('payload-button');
                        buttonElement.textContent = button.title;
                        buttonElement.onclick = function () {
                            sendPayload(button.payload);
                        };

                        buttonsContainer.appendChild(buttonElement);
                    });

                    chatBody.appendChild(buttonsContainer);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }
</script>

<script>
function readAloud(button, text) {
    const speechSynthesis = window.speechSynthesis;

    if (button.classList.contains('reading')) {
        // If speech is currently being read, stop it
        speechSynthesis.cancel();
        button.innerHTML = '<i class="fa-solid fa-volume-low"></i>';
        button.classList.remove('reading');
    } else {
        // If speech is not being read, start reading
        const speechUtterance = new SpeechSynthesisUtterance(text);
        speechSynthesis.speak(speechUtterance);
        button.innerHTML = '<i class="fa-solid fa-stop"></i>';
        button.classList.add('reading');
    }
}
</script>


<!-- changing of send button and voice button -->
<!-- <script>
  const userInput = document.getElementById('user-input');
  const voiceBtn = document.getElementById('voice-btn');
  const sendBtn = document.getElementById('sendMessage');

  userInput.addEventListener('input', function () {
      const message = this.querySelector('input').value.trim();
      if (message === '') {
          // No input, show voice button
          voiceBtn.style.display = 'inline-block';
          sendBtn.style.display = 'none';
      } else {
          // Input exists, show send button
          voiceBtn.style.display = 'none';
          sendBtn.style.display = 'inline-block';
      }
  });
</script> -->


<!-- just toggle for resposive webpage -->
<script>
const toggleBtn = document.querySelector('.toggle_btn')
const toggleBtnIcon = document.querySelector('.toggle_btn i')
const dropDownMenu = document.querySelector('.dropdown_menu')

toggleBtn.onclick = function () {
    dropDownMenu.classList.toggle('open')
    const isOpen = dropDownMenu.classList.contains('open')

    toggleBtnIcon.classList = isOpen
    ? 'fa-solid fa-xmark'
    : 'fa-solid fa-bars'
    }
</script>


</body>
</html>
